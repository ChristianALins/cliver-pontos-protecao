<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Portal do Cliente - CLIVER CORRETORA DE SEGUROS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
           background:#f5f7fb; margin:0; padding:0; }
    header { background:#152238; color:#fff; padding:16px 24px; }
    header h1 { margin:0; font-size:20px; }
    header small { font-size:12px; opacity:.85; }
    main { max-width:900px; margin:0 auto; padding:16px; }
    .card {
      background:#fff; border-radius:8px; padding:16px;
      box-shadow:0 2px 4px rgba(0,0,0,.05); margin-bottom:16px;
    }
    label { display:block; font-size:13px; margin-bottom:4px; }
    input {
      width:100%; padding:8px; border-radius:4px;
      border:1px solid #ccc; box-sizing:border-box; font-size:13px;
    }
    button {
      margin-top:10px; padding:8px 14px; border-radius:4px; border:none;
      background:#1e88e5; color:#fff; cursor:pointer; font-size:13px;
    }
    button:hover { background:#1565c0; }
    .muted { font-size:12px; color:#666; margin-top:4px; }
    .saldo { font-size:24px; font-weight:bold; color:#1e88e5; }
    .grid { display:flex; flex-wrap:wrap; gap:16px; }
    .grid>div { flex:1; min-width:200px; }
    table { width:100%; border-collapse:collapse; font-size:12px; margin-top:8px; }
    th,td { padding:6px 4px; border-bottom:1px solid #eee; text-align:left; }
    th { background:#f0f2f7; }
    .tag { display:inline-block; padding:2px 6px; border-radius:4px; font-size:11px; }
    .tag-ganho { background:#e8f5e9; color:#2e7d32; }
    .tag-resgate { background:#ffebee; color:#c62828; }
    .center { text-align:center; }
    .error { color:#c62828; font-size:13px; margin-top:6px; }
    .info-box {
      background:#e6fffa; border-left:4px solid #38b6a3;
      padding:10px; border-radius:6px; font-size:13px; color:#134e4a;
      margin-top:10px;
    }
    @media (max-width:700px){ .grid{flex-direction:column;} }
  </style>
</head>
<body>
<header>
  <h1>Portal do Cliente – CLIVER CORRETORA DE SEGUROS</h1>
  <small>Consulte seu saldo de pontos e extrato do Clube de Vantagens</small>
</header>

<main>
  <div class="card">
    <h2 style="margin-top:0;">Identificação do Cliente</h2>
    <label for="cpfBusca">Informe seu CPF (somente números)</label>
    <input id="cpfBusca" type="text" placeholder="Ex: 12345678900">
    <button onclick="buscarCliente()">Consultar</button>
    <div id="mensagemErro" class="error"></div>
    <div class="muted">
      Seus dados são usados apenas para localizar seu saldo dentro deste navegador.
    </div>
    <div class="info-box">
      Este portal lê os dados gravados pelo sistema administrativo
      (<code>index.html</code>) usando a mesma base local.
      Utilize no mesmo navegador/computador em que o sistema é operado.
    </div>
  </div>

  <div id="areaResultados" style="display:none;">
    <div class="card">
      <h2 style="margin-top:0;">Dados do Cliente</h2>
      <p><strong>Nome:</strong> <span id="cliNome"></span></p>
      <p><strong>CPF:</strong> <span id="cliCPF"></span></p>
      <p><strong>Email:</strong> <span id="cliEmail"></span></p>
      <p><strong>Telefone:</strong> <span id="cliTelefone"></span></p>
      <p><strong>Seguro principal:</strong> <span id="cliSeguro"></span></p>
      <p><strong>Desde:</strong> <span id="cliData"></span></p>
    </div>

    <div class="card">
      <h2 style="margin-top:0;">Saldo de Pontos</h2>
      <div class="grid">
        <div>
          <div class="muted">Saldo atual</div>
          <div id="saldoPontos" class="saldo">0</div>
        </div>
        <div>
          <div class="muted">Equivalente estimado</div>
          <div id="saldoReais" class="saldo">R$ 0,00</div>
        </div>
      </div>
      <div class="muted" style="margin-top:8px;">
        Regra: 10 pontos = R$ 1,00 em descontos ou serviços dentro do Clube de Vantagens.
      </div>
    </div>

    <div class="card">
      <h2 style="margin-top:0;">Extrato de Pontos</h2>
      <div class="muted">Movimentações mais recentes aparecem primeiro.</div>
      <table>
        <thead>
          <tr>
            <th>Data/Hora</th>
            <th>Tipo</th>
            <th>Descrição</th>
            <th>Pontos</th>
          </tr>
        </thead>
        <tbody id="tabelaExtrato"></tbody>
      </table>
    </div>
  </div>
</main>

<script>
  const STORAGE_KEY = 'programaPontosProtecao_v1';

  function normalizarCPF(cpf) {
    return (cpf || '').replace(/\D/g,'');
  }

  function carregarEstado() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return { clientes:[], movimentos:[] };
      const dados = JSON.parse(raw);
      return {
        clientes: Array.isArray(dados.clientes) ? dados.clientes : [],
        movimentos: Array.isArray(dados.movimentos) ? dados.movimentos : []
      };
    } catch (e) {
      console.error('Erro ao ler localStorage:', e);
      return { clientes:[], movimentos:[] };
    }
  }

  function buscarCliente() {
    const cpfBruto = document.getElementById('cpfBusca').value;
    const cpf = normalizarCPF(cpfBruto);
    const msgErro = document.getElementById('mensagemErro');
    const areaResultados = document.getElementById('areaResultados');
    msgErro.textContent = '';
    areaResultados.style.display = 'none';

    if (!cpf || cpf.length < 11) {
      msgErro.textContent = 'Informe um CPF válido (11 dígitos).';
      return;
    }

    const { clientes, movimentos } = carregarEstado();
    if (!clientes.length) {
      msgErro.textContent = 'Nenhum dado encontrado neste navegador. Abra o sistema administrativo (index.html) e cadastre clientes primeiro.';
      return;
    }

    const cliente = clientes.find(c => normalizarCPF(c.cpf) === cpf);
    if (!cliente) {
      msgErro.textContent = 'CPF não encontrado no programa de pontos neste navegador.';
      return;
    }

    preencherCliente(cliente);
    preencherSaldoEExtrato(cliente, movimentos);
    areaResultados.style.display = 'block';
  }

  function preencherCliente(c) {
    document.getElementById('cliNome').textContent = c.nome || '';
    document.getElementById('cliCPF').textContent = c.cpf || '';
    document.getElementById('cliEmail').textContent = c.email || '';
    document.getElementById('cliTelefone').textContent = c.telefone || '';
    document.getElementById('cliSeguro').textContent = c.tipoSeguro || '';
    document.getElementById('cliData').textContent = c.dataFiliacao || c.dataCadastro || '';
  }

  function preencherSaldoEExtrato(cliente, movimentos) {
    const saldo = cliente.pontos ?? cliente.saldoPontos ?? 0;
    document.getElementById('saldoPontos').textContent = saldo;
    document.getElementById('saldoReais').textContent = 'R$ ' + (saldo/10).toFixed(2).replace('.',',');

    const extrato = movimentos
      .filter(m => m.clienteId === cliente.id)
      .slice()
      .sort((a,b) => new Date(b.dataISO || b.data) - new Date(a.dataISO || a.data));

    const tbody = document.getElementById('tabelaExtrato');
    tbody.innerHTML = '';

    if (!extrato.length) {
      tbody.innerHTML = '<tr><td colspan="4" class="center" style="color:#666;">Nenhuma movimentação registrada ainda.</td></tr>';
      return;
    }

    extrato.forEach(m => {
      const tr = document.createElement('tr');
      const dataStr = m.dataISO || m.data || '';
      const dataFmt = dataStr ? new Date(dataStr).toLocaleString('pt-BR') : '';
      const ganho = m.tipo === 'acumulo' || m.direcao === 'ganho';
      const tipoLabel = ganho ? 'Ganho de pontos' : 'Resgate de pontos';
      const tagClass = ganho ? 'tag tag-ganho' : 'tag tag-resgate';
      const sinal = ganho ? '+' : '-';

      tr.innerHTML = `
        <td>${dataFmt}</td>
        <td><span class="${tagClass}">${tipoLabel}</span></td>
        <td>${m.descricao || ''}</td>
        <td>${sinal}${m.pontos}</td>
      `;
      tbody.appendChild(tr);
    });
  }
</script>
</body>
</html>
